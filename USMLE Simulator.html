<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>NBME-Style Practice Test</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <link rel="manifest" href="./manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        }
    </script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #f8f8f8;
            font-size: 14px;
        }

        .container {
            width: 90%;
            max-width: 1400px;
            margin: auto;
            background: #fff;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            max-height: 100vh;
            overflow: hidden;
            box-sizing: border-box;
        }

        #exam-status {
            display: none;
            text-align: center;
            font-size: 1em;
            color: green;
            margin-bottom: 10px;
            font-weight: bold;
        }

        textarea {
            width: 25%;
            height: 20px;
            box-sizing: border-box;
            margin-top: 10px;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .review-list li {
            cursor: pointer;
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #ccc;
        }

        .review-list li:hover {
            background: #eef;
        }

        #labs-tab {
            padding: 10px 0;
        }

        .scrollable-content {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 5px;
        }

        #lab-search {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        mark {
            background-color: yellow;
        }

        canvas {
            display: block;
            margin: auto;
            max-height: 600px;
            height: auto !important;
            border: 1px solid #ccc;
        }

        #pdf-canvas {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: auto;
        }

        .answer-sheet {
            display: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 12px;
        }

        table, th, td {
            border: 1px solid #ccc;
        }

        th, td {
            padding: 5px;
            text-align: left;
        }

        th {
            background: #ddd;
        }

        .ls-tab-subhead {
            background: #eee;
            font-weight: bold;
            text-align: center;
        }

        .group td {
            padding-left: 20px;
        }

        #lab-tabs {
            margin-top: 10px;
        }

        .tab-highlight {
            background-color: yellow !important;
        }

        .flag-icon {
            font-size: 24px;
            color: grey;
            cursor: pointer;
            margin-left: 10px;
        }

        .flag-icon.flagged {
            color: red;
        }

        #question-tab h2 {
            font-size: .9em;
            margin: 2px 0;
        }

        #review-tab {
            display: flex;
            flex-direction: column;
            height: 80vh;
            overflow: hidden;
        }

        #review-list-container {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            padding: 5px;
            max-height: 100%; /* Full size during the exam */
            transition: max-height 0.3s ease; /* Smooth transition */
        }

        #review-list-container.submitted {
            max-height: 25%; /* Reduced size after submission */
        }

        #answer-sheet-container {
            flex-grow: 1;
            overflow-y: auto; /* Scrollability for the answer PDF */
            padding-top: 10px;
            border-top: 1px solid #ccc;
            max-height: 0; /* Hidden during the exam */
            transition: max-height 0.3s ease; /* Smooth transition */
        }

        #answer-sheet-container.visible {
            max-height: 75%; /* Visible after submission */
        }

        #answer-box {
            flex-grow: 1;
            margin: 0 10px;
            height: 30px;
            font-size: 14px;
        }

        .upload-section {
            margin-top: 5px;
            padding: 3px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #f9f9f9;
        }

        .upload-section h4 {
            margin: 0;
            font-size: 0.9em;
            cursor: pointer;
            text-align: center;
            background: #ddd;
            padding: 3px;
            border-radius: 5px;
        }

        .upload-section-content {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .upload-section-content label {
            margin: 0;
            font-size: 0.9em;
        }

        .upload-section-content input[type="file"] {
            font-size: 0.9em;
        }

        #tabs ul li a {
            font-size: 0.9em;
            padding: 5px 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="tabs">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <ul style="display: flex; margin: 0; padding: 0; list-style: none;">
                    <li style="margin-right: 10px;"><a href="#question-tab">Question</a></li>
                    <li style="margin-right: 10px;"><a href="#labs-tab">Lab Values</a></li>
                    <li><a href="#review-tab" id="review-tab-tab">Review Answers</a></li>
                </ul>
                <div id="timer-container" style="font-size: 1.2em; font-weight: bold;"></div>
            </div>
            <div id="question-tab">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 id="question-title">Question 1</h2>
                </div>
                <button id="start-exam-btn" style="margin-bottom: 10px;" disabled>Start Exam</button>
                <canvas id="pdf-canvas"></canvas>
                <div class="navigation-bar">
                    <button id="prev-btn">Previous</button>
                    <textarea id="answer-box" placeholder="Type your answer here..."></textarea>
                    <button id="next-btn">Next</button>
                    <label id="flag-container" style="cursor: pointer; display: inline-flex; align-items: center;">
                        <input type="checkbox" id="flag-checkbox" style="display: none;">
                        <span id="flag-icon" class="flag-icon">ðŸš©</span>
                    </label>
                </div>
                <div class="upload-section">
                    <h4 id="toggle-upload">Upload Options â–¼</h4>
                    <div class="upload-section-content">
                        <label><strong>Upload Question PDF:</strong></label>
                        <input type="file" id="pdf-upload" accept="application/pdf">
                        <label><strong>Upload Answer Sheet (PDF):</strong></label>
                        <input type="file" id="pdf-answer-upload" accept="application/pdf">
                    </div>
                </div>
            </div>
            <div id="labs-tab">
                <h3>Standard NBME Lab Values</h3>
                <input type="text" id="lab-search" placeholder="Search lab values...">
                <div class="lab-values" id="lab-values-content">
                    <div id="lab-tabs">
                        <ul>
                            <li><a href="#lab-serum">Serum</a></li>
                            <li><a href="#lab-cerebrospinal">Cerebrospinal</a></li>
                            <li><a href="#lab-blood">Blood</a></li>
                            <li><a href="#lab-urine">Urine and BMI</a></li>
                        </ul>
                        <div id="lab-serum">
                            <div class="scrollable-content">
                                <div data-e2e-test-id="lab-values" class="_760ee638b575af4a--labValuesWrapper _4e64c561df129b20--labValuesContentContainer" style="font-size: 12px;">
                                    <h1>Lab Values</h1>
                                    <table class="ls-tab-indented-light js-ls-tab-view" data-title="Serum">
                                        <thead>
                                            <tr>
                                                <th class="labName">Serum</th>
                                                <th class="refRange">Reference Range</th>
                                                <th class="SI">SI Reference</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Alanine aminotransferase (ALT)</td>
                                                <td class="refRange">10â€“40 U/L</td>
                                                <td class="SI">10â€“40 U/L</td>
                                            </tr>
                                            <tr>
                                                <td>Aspartate aminotransferase (AST)</td>
                                                <td class="refRange">12â€“38 U/L</td>
                                                <td class="SI">12â€“38 U/L</td>
                                            </tr>
                                            <tr>
                                                <td>Alkaline phosphatase</td>
                                                <td class="refRange">25â€“100 U/L</td>
                                                <td class="SI">25â€“100 U/L</td>
                                            </tr>
                                            <tr>
                                                <td>Amylase</td>
                                                <td class="refRange">25â€“125 U/L</td>
                                                <td class="SI">25â€“125 U/L</td>
                                            </tr>
                                            <tr>
                                                <td>Bilirubin, Total // Direct</td>
                                                <td class="refRange">0.1â€“1.0 mg/dL // 0.0â€“0.3 mg/dL</td>
                                                <td class="SI">2â€“17 Âµmol/L // 0â€“5 Âµmol/L</td>
                                            </tr>
                                            <tr>
                                                <td>Calcium</td>
                                                <td class="refRange">8.4â€“10.2 mg/dL</td>
                                                <td class="SI">2.1â€“2.6 mmol/L</td>
                                            </tr>
                                            <tr>
                                                <td class="ls-tab-subhead labName" colspan="3">Cholesterol</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒTotal</td>
                                                <td class="refRange">Normal: &lt;200 mg/dL // High: &gt;240 mg/dL</td>
                                                <td class="SI">&lt;5.2 mmol/L // &gt;6.2 mmol/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒHDL</td>
                                                <td class="refRange">40â€“60 mg/dL</td>
                                                <td class="SI">1.0â€“1.6 mmol/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒLDL</td>
                                                <td class="refRange">&lt;160 mg/dL</td>
                                                <td class="SI">&lt;4.2 mmol/L</td>
                                            </tr>
                                            <tr>
                                                <td>Triglycerides</td>
                                                <td class="refRange">Normal: &lt;150 mg/dL // Borderline: 151â€“199 mg/dL</td>
                                                <td class="SI">&lt;1.70 mmol/L // 1.71â€“2.25 mmol/L</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="2">Cortisol</td>
                                                <td class="refRange">0800 h: 5â€“23 Âµg/dL // 1600 h: 3â€“15 Âµg/dL</td>
                                                <td class="SI">138â€“635 nmol/L // 82â€“413 nmol/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">2000 h: &lt;50% of 0800 h</td>
                                                <td class="SI">Fraction of 0800 h: &lt;0.50</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="2">Creatine kinase</td>
                                                <td class="refRange">Male: 25â€“90 U/L</td>
                                                <td class="SI">25â€“90 U/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Female: 10â€“70 U/L</td>
                                                <td class="SI">10â€“70 U/L</td>
                                            </tr>
                                            <tr>
                                                <td>Creatinine</td>
                                                <td class="refRange">0.6â€“1.2 mg/dL</td>
                                                <td class="SI">53â€“106 Âµmol/L</td>
                                            </tr>
                                            <tr>
                                                <td>Urea nitrogen</td>
                                                <td class="refRange">7â€“18 mg/dL</td>
                                                <td class="SI">2.5â€“6.4 mmol/L</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="2">Creatinine clearance</td>
                                                <td class="refRange">Male: 97â€“137mL/min</td>
                                                <td class="SI">97â€“137mL/min</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Female: 88â€“128 mL/min</td>
                                                <td class="SI">88â€“128 mL/min</td>
                                            </tr>
                                            <tr>
                                                <td class="ls-tab-subhead labName" colspan="3">Electrolytes, serum</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒSodium (Na<sup>+</sup>)</td>
                                                <td class="refRange">136â€“146 mEq/L</td>
                                                <td class="SI">136â€“146 mmol/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒPotassium (K<sup>+</sup>)</td>
                                                <td class="refRange">3.5â€“5.0 mEq/L</td>
                                                <td class="SI">3.5â€“5.0 mmol/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒChloride (Cl<sup>âˆ’</sup>)</td>
                                                <td class="refRange">95â€“105 mEq/L</td>
                                                <td class="SI">95â€“105 mmol/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒBicarbonate (HCO<sub>3</sub><sup>âˆ’</sup>)</td>
                                                <td class="refRange">22â€“28 mEq/L</td>
                                                <td class="SI">22â€“28 mmol/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒMagnesium (Mg<sup>2+</sup>)</td>
                                                <td class="refRange">1.5â€“2.0 mg/dL</td>
                                                <td class="SI">0.75â€“1.0 mmol/L</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="2">Ferritin</td>
                                                <td class="refRange">Male: 20â€“250 ng/mL</td>
                                                <td class="SI">20â€“250 Âµg/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Female: 10â€“120 ng/mL</td>
                                                <td class="SI">10â€“120 Âµg/L</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="4">Follicle-stimulating hormone</td>
                                                <td class="refRange">Male: 4â€“25 mIU/mL</td>
                                                <td class="SI">4â€“25 U/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Female: premenopause 4â€“30 mIU/mL</td>
                                                <td class="SI">4â€“30 U/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">â€ƒmidcycle peak 10â€“90 mIU/mL</td>
                                                <td class="SI">10â€“90 U/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">â€ƒpostmenopause 40â€“250 mIU/mL</td>
                                                <td class="SI">40â€“250 U/L</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="2">Glucose</td>
                                                <td class="refRange">Fasting: 70â€“100 mg/dL</td>
                                                <td class="SI">3.8â€“5.6 mmol/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Random, non-fasting: &lt;140 mg/dL</td>
                                                <td class="SI">&lt;7.77 mmol/L</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="2">Growth hormone - arginine stimulation</td>
                                                <td class="refRange">Fasting: &lt;5 ng/mL</td>
                                                <td class="SI">&lt;5 Âµg/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Provocative stimuli: &gt;7 ng/mL</td>
                                                <td class="SI">&gt;7 Âµg/L</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="2">Iron</td>
                                                <td class="refRange">Male: 65â€“175 Âµg/dL</td>
                                                <td class="SI">11.6â€“31.3 Âµmol/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Female: 50â€“170 Âµg/dL</td>
                                                <td class="SI">9.0â€“30.4 Âµmol/L</td>
                                            </tr>
                                            <tr>
                                                <td>Total iron-binding capacity</td>
                                                <td class="refRange">250â€“400 Âµg/dL</td>
                                                <td class="SI">44.8â€“71.6 Âµmol/L</td>
                                            </tr>
                                            <tr>
                                                <td>Transferrin</td>
                                                <td class="refRange">200â€“360 mg/dL</td>
                                                <td class="SI">2.0â€“3.6 g/L</td>
                                            </tr>
                                            <tr>
                                                <td>Lactate dehydrogenase</td>
                                                <td class="refRange">45â€“200 U/L</td>
                                                <td class="SI">45â€“200 U/L</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="4">Luteinizing hormone</td>
                                                <td class="refRange">Male: 6â€“23 mIU/mL</td>
                                                <td class="SI">6â€“23 U/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Female: follicular phase 5â€“30 mIU/mL</td>
                                                <td class="SI">5â€“30 IU/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">â€ƒmidcycle 75â€“150 mIU/mL</td>
                                                <td class="SI">75â€“150 IU/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">â€ƒpostmenopause 30â€“200 mIU/mL</td>
                                                <td class="SI">30â€“200 IU/L</td>
                                            </tr>
                                            <tr>
                                                <td>Osmolality</td>
                                                <td class="refRange">275â€“295 mOsmol/kg H<sub>2</sub>O</td>
                                                <td class="SI">275â€“295 mOsmol/kg H<sub>2</sub>O</td>
                                            </tr>
                                            <tr>
                                                <td>Intact parathyroid hormone (PTH)</td>
                                                <td class="refRange">10â€“60 pg/mL</td>
                                                <td class="SI">10â€“60 ng/L</td>
                                            </tr>
                                            <tr>
                                                <td>Phosphorus (inorganic)</td>
                                                <td class="refRange">3.0â€“4.5 mg/dL</td>
                                                <td class="SI">1.0â€“1.5 mmol/L</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="2">Prolactin (hPRL)</td>
                                                <td class="refRange">Male: &lt;17 ng/mL</td>
                                                <td class="SI">&lt;17 Âµg/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Female: &lt;25 ng/mL</td>
                                                <td class="SI">&lt;25 Âµg/L</td>
                                            </tr>
                                            <tr>
                                                <td class="ls-tab-subhead labName" colspan="3">Proteins</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒTotal</td>
                                                <td class="refRange">6.0â€“7.8 g/dL</td>
                                                <td class="SI">60â€“78 g/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒAlbumin</td>
                                                <td class="refRange">3.5â€“5.5 g/dL</td>
                                                <td class="SI">35â€“55 g/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒGlobulin</td>
                                                <td class="refRange">2.3â€“3.5 g/dL</td>
                                                <td class="SI">23â€“35 g/L</td>
                                            </tr>
                                            <tr>
                                                <td>Troponin I</td>
                                                <td class="refRange">â‰¤0.04 ng/mL</td>
                                                <td class="SI">â‰¤0.04 Âµg/L</td>
                                            </tr>
                                            <tr>
                                                <td>TSH</td>
                                                <td class="refRange">0.4â€“4.0 Î¼U/mL</td>
                                                <td class="SI">0.4â€“4.0 mIU/L</td>
                                            </tr>
                                            <tr>
                                                <td>Thyroidal iodine (<sup>123</sup>I) uptake</td>
                                                <td class="refRange">8%â€“30% of administered dose/24 h</td>
                                                <td class="SI">0.08â€“0.30/24 h</td>
                                            </tr>
                                            <tr>
                                                <td>Thyroxine (T<sub>4</sub>)</td>
                                                <td class="refRange">5â€“12 Âµg/dL</td>
                                                <td class="SI">64â€“155 nmol/L</td>
                                            </tr>
                                            <tr>
                                                <td>Free T<sub>4</sub></td>
                                                <td class="refRange">0.9â€“1.7 ng/dL</td>
                                                <td class="SI">12.0â€“21.9 pmol/L</td>
                                            </tr>
                                            <tr>
                                                <td>Triiodothyronine (T<sub>3</sub>) (RIA)</td>
                                                <td class="refRange">100â€“200 ng/dL</td>
                                                <td class="SI">1.5â€“3.1 nmol/L</td>
                                            </tr>
                                            <tr>
                                                <td>Triiodothyronine (T<sub>3</sub>) resin uptake</td>
                                                <td class="refRange">25%â€“35%</td>
                                                <td class="SI">0.25â€“0.35</td>
                                            </tr>
                                            <tr>
                                                <td>Uric acid</td>
                                                <td class="refRange">3.0â€“8.2 mg/dL</td>
                                                <td class="SI">0.18â€“0.48 mmol/L</td>
                                            </tr>
                                            <tr>
                                                <td class="ls-tab-subhead labName" colspan="3">Immunoglobulins</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒIgA</td>
                                                <td class="refRange">76â€“390 mg/dL</td>
                                                <td class="SI">0.76â€“3.90 g/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒIgE</td>
                                                <td class="refRange">0â€“380 IU/mL</td>
                                                <td class="SI">0â€“380 kIU/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒIgG</td>
                                                <td class="refRange">650â€“1500 mg/dL</td>
                                                <td class="SI">6.5â€“15.0 g/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒIgM</td>
                                                <td class="refRange">50â€“300 mg/dL</td>
                                                <td class="SI">0.5â€“3.0 g/L</td>
                                            </tr>
                                            <tr>
                                                <td class="ls-tab-subhead" colspan="3">Gases, arterial blood (room air)</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒpH</td>
                                                <td class="refRange">7.35â€“7.45</td>
                                                <td class="SI">[H<sup>+</sup>] 36â€“44 nmol/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒPco<sub>2</sub></td>
                                                <td class="refRange">33â€“45 mm Hg</td>
                                                <td class="SI">4.4â€“5.9 kPa</td>
                                            </tr>
                                            <tr class="group">
                                                <td>â€ƒPo<sub>2</sub></td>
                                                <td class="refRange">75â€“105 mm Hg</td>
                                                <td class="SI">10.0â€“14.0 kPa</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div id="lab-cerebrospinal">
                            <div class="scrollable-content">
                                <div data-e2e-test-id="lab-values" class="_760ee638b575af4a--labValuesWrapper _4e64c561df129b20--labValuesContentContainer" style="font-size: 12px;">
                                    <table class="ls-tab-indented-light js-ls-tab-view" data-title="Cerebrospinal">
                                        <thead>
                                            <tr>
                                                <th class="labName"><br>Cerebrospinal Fluid</th>
                                                <th class="refRange"><br>Reference Range</th>
                                                <th class="SI"><br>SI Reference</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Cell count</td>
                                                <td class="refRange">0â€“5/mm<sup>3</sup></td>
                                                <td class="SI">0â€“5 x 10<sup>6</sup>/L</td>
                                            </tr>
                                            <tr>
                                                <td>Chloride</td>
                                                <td class="refRange">118â€“132 mEq/L</td>
                                                <td class="SI">118â€“132 mmol/L</td>
                                            </tr>
                                            <tr>
                                                <td>Gamma globulin</td>
                                                <td class="refRange">3%â€“12% total proteins</td>
                                                <td class="SI">0.03â€“0.12</td>
                                            </tr>
                                            <tr>
                                                <td>Glucose</td>
                                                <td class="refRange">40â€“70 mg/dL</td>
                                                <td class="SI">2.2â€“3.9 mmol/L</td>
                                            </tr>
                                            <tr>
                                                <td>Pressure</td>
                                                <td class="refRange">70â€“180 mm H<sub>2</sub>O</td>
                                                <td class="SI">70â€“180 mm H<sub>2</sub>O</td>
                                            </tr>
                                            <tr>
                                                <td>Proteins, total</td>
                                                <td class="refRange">&lt;40 mg/dL</td>
                                                <td class="SI">&lt;0.40 g/L</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div id="lab-blood">
                            <div class="scrollable-content">
                                <div data-e2e-test-id="lab-values" class="_760ee638b575af4a--labValuesWrapper _4e64c561df129b20--labValuesContentContainer" style="font-size: 12px;">
                                    <table class="ls-tab-indented-light js-ls-tab-view" data-title="Hematologic">
                                        <thead>
                                            <tr>
                                                <th class="labName">Hematologic</th>
                                                <th class="refRange">Reference Range</th>
                                                <th class="SI">SI Reference</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td rowspan="2">Erythrocyte count</td>
                                                <td class="refRange">Male: 4.3â€“5.9 million/mm<sup>3</sup></td>
                                                <td class="SI">4.3â€“5.9 x 10<sup>12</sup>/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Female: 3.5â€“5.5 million/mm<sup>3</sup></td>
                                                <td class="SI">3.5â€“5.5 x 10<sup>12</sup>/L</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="2">Erythrocyte sedimentation rate (Westergren)</td>
                                                <td class="refRange">Male: 0â€“15 mm/h</td>
                                                <td class="SI">0â€“15 mm/h</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Female: 0â€“20 mm/h</td>
                                                <td class="SI">0â€“20 mm/h</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="2">Hematocrit</td>
                                                <td class="refRange">Male: 41%â€“53%</td>
                                                <td class="SI">0.41â€“0.53</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Female: 36%â€“46%</td>
                                                <td class="SI">0.36â€“0.46</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="2">Hemoglobin, blood</td>
                                                <td class="refRange">Male: 13.5â€“17.5 g/dL</td>
                                                <td class="SI">135â€“175 g/L</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Female: 12.0â€“16.0 g/dL</td>
                                                <td class="SI">120â€“160 g/L</td>
                                            </tr>
                                            <tr>
                                                <td>Hemoglobin A<sub>1c</sub></td>
                                                <td class="refRange">â‰¤6%</td>
                                                <td class="SI">â‰¤42 mmol/mol</td>
                                            </tr>
                                            <tr>
                                                <td>Hemoglobin, plasma</td>
                                                <td class="refRange">&lt;4 mg/dL</td>
                                                <td class="SI">&lt;0.62 mmol/L</td>
                                            </tr>
                                            <tr>
                                                <td>Leukocyte count (WBC)</td>
                                                <td class="refRange">4500â€“11,000/mm<sup>3</sup></td>
                                                <td class="SI">4.5â€“11.0 x 10<sup>9</sup>/L</td>
                                            </tr>
                                            <tr>
                                                <td>â€ƒNeutrophils, segmented</td>
                                                <td class="refRange">54%â€“62%</td>
                                                <td class="SI">0.54â€“0.62</td>
                                            </tr>
                                            <tr>
                                                <td>â€ƒNeutrophils, bands</td>
                                                <td class="refRange">3%â€“5%</td>
                                                <td class="SI">0.03â€“0.05</td>
                                            </tr>
                                            <tr>
                                                <td>â€ƒEosinophils</td>
                                                <td class="refRange">1%â€“3%</td>
                                                <td class="SI">0.01â€“0.03</td>
                                            </tr>
                                            <tr>
                                                <td>â€ƒBasophils</td>
                                                <td class="refRange">0%â€“0.75%</td>
                                                <td class="SI">0.00â€“0.0075</td>
                                            </tr>
                                            <tr>
                                                <td>â€ƒLymphocytes</td>
                                                <td class="refRange">25%â€“33%</td>
                                                <td class="SI">0.25â€“0.33</td>
                                            </tr>
                                            <tr>
                                                <td>â€ƒMonocytes</td>
                                                <td class="refRange">3%â€“7%</td>
                                                <td class="SI">0.03â€“0.07</td>
                                            </tr>
                                            <tr>
                                                <td>CD4+ T-lymphocyte count</td>
                                                <td class="refRange">&gt;500/mm<sup>3</sup></td>
                                                <td class="SI">&gt;0.5 x 10<sup>9</sup>/L</td>
                                            </tr>
                                            <tr>
                                                <td>Platelet count</td>
                                                <td class="refRange">150,000â€“400,000/mm<sup>3</sup></td>
                                                <td class="SI">150â€“400 x 10<sup>9</sup>/L</td>
                                            </tr>
                                            <tr>
                                                <td>Reticulocyte count</td>
                                                <td class="refRange">0.5%â€“1.5%</td>
                                                <td class="SI">0.005â€“0.015</td>
                                            </tr>
                                            <tr>
                                                <td>D-Dimer</td>
                                                <td class="refRange">â‰¤250 ng/mL</td>
                                                <td class="SI">â‰¤1.4 nmol/L</td>
                                            </tr>
                                            <tr>
                                                <td>Partial thromboplastin time (PTT) (activated)</td>
                                                <td class="refRange">25â€“40 seconds</td>
                                                <td class="SI">25â€“40 seconds</td>
                                            </tr>
                                            <tr>
                                                <td>Prothrombin time (PT)</td>
                                                <td class="refRange">11â€“15 seconds</td>
                                                <td class="SI">11â€“15 seconds</td>
                                            </tr>
                                            <tr>
                                                <td>Mean corpuscular hemoglobin (MCH)</td>
                                                <td class="refRange">25â€“35 pg/cell</td>
                                                <td class="SI">0.39â€“0.54 fmol/cell</td>
                                            </tr>
                                            <tr>
                                                <td>Mean corpuscular hemoglobin concentration (MCHC)</td>
                                                <td class="refRange">31%â€“36% Hb/cell</td>
                                                <td class="SI">4.8â€“5.6 mmol Hb/L</td>
                                            </tr>
                                            <tr>
                                                <td>Mean corpuscular volume (MCV)</td>
                                                <td class="refRange">80â€“100 Âµm<sup>3</sup></td>
                                                <td class="SI">80â€“100 fL</td>
                                            </tr>
                                            <tr>
                                                <td class="ls-tab-subhead" colspan="3">Volume</td>
                                            </tr>
                                            <tr class="group">
                                                <td rowspan="2">â€ƒPlasma</td>
                                                <td class="refRange">Male: 25â€“43 mL/kg</td>
                                                <td class="SI">0.025â€“0.043 L/kg</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Female: 28â€“45 mL/kg</td>
                                                <td class="SI">0.028â€“0.045 L/kg</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div id="lab-urine">
                            <div class="scrollable-content">
                                <div data-e2e-test-id="lab-values" class="_760ee638b575af4a--labValuesWrapper _4e64c561df129b20--labValuesContentContainer" style="font-size: 12px;">
                                    <table class="ls-tab-indented-light js-ls-tab-view" data-title="Urine and BMI">
                                        <thead>
                                            <tr>
                                                <th class="labName"><br>Urine</th>
                                                <th class="refRange"><br>Reference Range</th>
                                                <th class="SI"><br>SI Reference</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Calcium</td>
                                                <td class="refRange">100â€“300 mg/24 h</td>
                                                <td class="SI">2.5â€“7.5 mmol/24 h</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="2">Creatinine clearance</td>
                                                <td class="refRange">Male: 97â€“137 mL/min</td>
                                                <td class="SI">97â€“137 mL/min</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Female: 88â€“128 mL/min</td>
                                                <td class="SI">88â€“128 mL/min</td>
                                            </tr>
                                            <tr>
                                                <td>Osmolality</td>
                                                <td class="refRange">50â€“1200 mOsmol/kg H<sub>2</sub>O</td>
                                                <td class="SI">50â€“1200 mOsmol/kg H<sub>2</sub>O</td>
                                            </tr>
                                            <tr>
                                                <td>Oxalate</td>
                                                <td class="refRange">8â€“40 Âµg/mL</td>
                                                <td class="SI">90â€“445 Âµmol/L</td>
                                            </tr>
                                            <tr>
                                                <td>Proteins, total</td>
                                                <td class="refRange">&lt;150 mg/24 h</td>
                                                <td class="SI">&lt;0.15 g/24 h</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="2">17-Hydroxycorticosteroids</td>
                                                <td class="refRange">Male: 3.0â€“10.0 mg/24 h</td>
                                                <td class="SI">8.2â€“27.6 Âµmol/24 h</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Female: 2.0â€“8.0 mg/24 h</td>
                                                <td class="SI">5.5â€“22.0 Âµmol/24 h</td>
                                            </tr>
                                            <tr>
                                                <td rowspan="2">17-Ketosteroids, total</td>
                                                <td class="refRange">Male: 8â€“20 mg/24 h</td>
                                                <td class="SI">28â€“70 Âµmol/24 h</td>
                                            </tr>
                                            <tr class="group">
                                                <td class="refRange">Female: 6â€“15 mg/24 h</td>
                                                <td class="SI">21â€“52 Âµmol/24 h</td>
                                            </tr>
                                            <thead>
                                                <tr>
                                                    <th class="labName"><br>Body Mass Index (BMI)</th>
                                                    <th class="refRange"><br>Reference Range</th>
                                                    <th class="SI">SI Reference</th>
                                                </tr>
                                            </thead>
                                        <tbody>
                                            <tr>
                                                <td class="labName">Body Mass Index (BMI)</td>
                                                <td class="refRange">Adult: 19â€“25 kg/m<sup>2</sup></td>
                                                <td class="SI"></td>
                                            </tr>
                                        </tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="review-tab">
                <div id="review-list-container">
                    <ul id="review-list" class="review-list"></ul>
                </div>
                <div class="answer-sheet" id="answer-sheet-container">
                    <div id="answer-controls">
                        <button id="prev-answer-page">Prev Answer Page</button>
                        <button id="next-answer-page">Next Answer Page</button>
                    </div>
                    <canvas id="answer-pdf-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        class ExamTimer {
            constructor(durationSeconds, displayId) {
                this.duration = durationSeconds; // Duration in seconds
                this.displayId = displayId;
                this.interval = null;
            }

            renderTimer(containerId) {
                const container = document.getElementById(containerId);
                const timerDisplay = document.createElement("div");
                timerDisplay.id = this.displayId;
                timerDisplay.style.fontSize = "1.2em";
                timerDisplay.style.fontWeight = "bold";
                container.appendChild(timerDisplay);
                this.updateDisplay();
            }

            start() {
                if (this.interval) return; // Prevent multiple intervals
                this.interval = setInterval(() => {
                    if (this.duration > 0) {
                        this.duration--;
                        this.updateDisplay();
                    } else {
                        clearInterval(this.interval);
                        alert("Time's up! The exam will be submitted automatically.");
                        document.getElementById("submit-exam").click();
                    }
                }, 1000);
            }

            updateDisplay() {
                const hours = Math.floor(this.duration / 3600);
                const minutes = Math.floor((this.duration % 3600) / 60);
                const seconds = this.duration % 60;
                const display = document.getElementById(this.displayId);
                if (display) {
                    display.textContent = `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
                }
            }
        }

        let currentQuestion = 1;
        let totalQuestions = 0;
        let answers = {};
        let examSubmitted = false;
        let questionPdfDoc = null;
        let answerPdfDoc = null;
        let currentAnswerPage = 1;
        let flaggedQuestions = {};
        let timer = null;
        let drawings = {}; // Store drawings for each question
        let isDrawing = false;
        let currentPath = [];
        let drawingMode = "highlighter"; // Default mode is highlighter

        const $tabs = $("#tabs");
        const $labTabs = $("#lab-tabs");
        const $labSearch = $("#lab-search");
        const $answerBox = $("#answer-box");
        const $reviewList = $("#review-list");
        let $submitExamBtn = $("<button id='submit-exam'>Submit Exam</button>").hide();
        $(".navigation-bar").append($submitExamBtn);

        const originalLabValuesHTML = $labTabs.html();

        function renderPdf(pdfDoc, pageNumber, canvasId) {
            pdfDoc.getPage(pageNumber).then(page => {
                const canvas = document.getElementById(canvasId);
                const context = canvas.getContext("2d");

                const scale = 2;
                const viewport = page.getViewport({ scale });
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                page.render({
                    canvasContext: context,
                    viewport: viewport
                });
            }).catch(error => {
                console.error(`Error rendering page ${pageNumber} of ${canvasId}:`, error);
            });
        }

        function saveCurrentAnswer() {
            answers[currentQuestion] = $answerBox.val();
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function updateQuestionTitle() {
            let flagIndicator = flaggedQuestions[currentQuestion] ? " <span class='flag-icon flagged'>ðŸš©</span>" : "";
            $("#question-title").html("Question " + currentQuestion + flagIndicator);
        }

        function updateFlagDisplay() {
            if (flaggedQuestions[currentQuestion]) {
                $("#flag-checkbox").prop("checked", true);
                $("#flag-icon").addClass("flagged");
            } else {
                $("#flag-checkbox").prop("checked", false);
                $("#flag-icon").removeClass("flagged");
            }
        }

        function toggleFlagQuestion() {
            if ($("#flag-checkbox").is(":checked")) {
                flaggedQuestions[currentQuestion] = true;
            } else {
                delete flaggedQuestions[currentQuestion];
            }
            updateFlagDisplay();
            updateReviewList();
            updateQuestionTitle();
        }

        $("#flag-checkbox").on("change", toggleFlagQuestion);

        function updateQuestion() {
            // If the exam is submitted, allow free navigation between all questions
            if (examSubmitted) {
                updateQuestionTitle();
                const answer = answers[currentQuestion];
                $answerBox.val(answer ? answer : "");
                renderQuestionPdf();
                updateFlagDisplay();
                return;
            }

            const blockStart = blockQuestions.slice(0, currentBlock - 1).reduce((a, b) => a + b, 0) + 1;
            const blockEnd = blockStart + blockQuestions[currentBlock - 1] - 1;

            // Ensure the current question stays within the current block
            if (currentQuestion < blockStart) {
                currentQuestion = blockStart;
            } else if (currentQuestion > blockEnd) {
                currentQuestion = blockEnd;
            }

            updateQuestionTitle();
            const answer = answers[currentQuestion];
            $answerBox.val(answer ? answer : "");
            renderQuestionPdf();
            updateFlagDisplay();

            // Show the "Submit Block" button for the last question of the current block
            if (currentQuestion === blockEnd && currentBlock < totalBlocks) {
                $("#next-btn").hide();
                if (!$("#submit-block-btn").length) {
                    $(".navigation-bar").append("<button id='submit-block-btn'>Submit Block</button>");
                    $("#submit-block-btn").on("click", submitBlock);
                }
                $("#submit-block-btn").show();
            } 
            // Show the "Submit Exam" button for the last question of the last block
            else if (currentBlock === totalBlocks && currentQuestion === blockEnd) {
                $("#next-btn").hide();
                $("#submit-block-btn").hide();
                $submitExamBtn.show();
            } 
            // Otherwise, show the "Next" button
            else {
                $("#next-btn").show();
                $("#submit-block-btn").hide();
                $submitExamBtn.hide();
            }

            // Update the review list to only show questions in the current block
            updateReviewList(blockStart, blockEnd);
        }

        function updateReviewList(blockStart, blockEnd) {
            const $reviewListContainer = $("#review-list-container");
            $reviewList.empty();

            // If the exam is submitted, show all questions
            if (examSubmitted) {
                blockStart = 1;
                blockEnd = totalQuestions;
            }

            for (let q = blockStart; q <= blockEnd; q++) {
                const ansText = answers[q] ? answers[q] : "[No answer]";
                const flagText = flaggedQuestions[q] ? " ðŸš©" : "";
                const $li = $(`<li data-q="${q}">Question ${q}: ${ansText}${flagText}</li>`);
                $reviewList.append($li);
            }
            $reviewListContainer.scrollTop(0);
        }

        function getCanvasCoordinates(event, canvas) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width; // Account for horizontal scaling
            const scaleY = canvas.height / rect.height; // Account for vertical scaling
            return {
                x: (event.clientX - rect.left) * scaleX,
                y: (event.clientY - rect.top) * scaleY
            };
        }

        function enableDrawing(canvas) {
            const context = canvas.getContext("2d");

            function startDrawing(event) {
                const { x, y } = getCanvasCoordinates(event, canvas);

                // Check if the click is near an existing highlight or pen stroke
                if (eraseHighlightIfClicked(x, y)) {
                    renderDrawings(canvas); // Redraw the canvas after erasing
                    return;
                }

                isDrawing = true;
                currentPath = [];
                currentPath.push({ x, y });
            }

            function draw(event) {
                if (!isDrawing) return;
                const { x, y } = getCanvasCoordinates(event, canvas);
                currentPath.push({ x, y });

                // Draw the current path based on the selected mode
                context.beginPath();
                context.moveTo(currentPath[currentPath.length - 2].x, currentPath[currentPath.length - 2].y);
                context.lineTo(x, y);

                if (drawingMode === "highlighter") {
                    context.strokeStyle = "rgba(255, 255, 0, 0.35)"; // Yellow with 35% transparency
                    context.lineWidth = 16; // Thicker line for highlighter
                } else if (drawingMode === "pen") {
                    context.strokeStyle = "rgba(0, 0, 0, 1)"; // Black solid line
                    context.lineWidth = 4; // Thicker line for pen
                }

                context.lineCap = "round"; // Smooth edges for both modes
                context.stroke();
                context.closePath();
            }

            function stopDrawing() {
                if (!isDrawing) return;
                isDrawing = false;

                // Save the current path to the drawings for the current question
                if (!drawings[currentQuestion]) {
                    drawings[currentQuestion] = [];
                }
                drawings[currentQuestion].push({ path: [...currentPath], mode: drawingMode });
            }

            function eraseHighlightIfClicked(x, y) {
                if (!drawings[currentQuestion]) return false;

                const threshold = 10; // Distance threshold to detect a click near a highlight or pen stroke
                for (let i = 0; i < drawings[currentQuestion].length; i++) {
                    const { path } = drawings[currentQuestion][i];
                    for (let point of path) {
                        const distance = Math.sqrt((point.x - x) ** 2 + (point.y - y) ** 2);
                        if (distance <= threshold) {
                            drawings[currentQuestion].splice(i, 1); // Remove the highlight or pen stroke
                            return true;
                        }
                    }
                }
                return false;
            }

            function toggleDrawingMode(event) {
                if (event.button === 2) { // Right-click
                    drawingMode = drawingMode === "highlighter" ? "pen" : "highlighter";
                }
            }

            canvas.addEventListener("mousedown", startDrawing);
            canvas.addEventListener("mousemove", draw);
            canvas.addEventListener("mouseup", stopDrawing);
            canvas.addEventListener("mouseleave", stopDrawing);
            canvas.addEventListener("contextmenu", (event) => {
                event.preventDefault(); // Prevent the default context menu
                toggleDrawingMode(event);
            });
        }

        function renderDrawings(canvas) {
            const context = canvas.getContext("2d");

            // Redraw the PDF page
            if (questionPdfDoc && currentQuestion <= totalQuestions) {
                questionPdfDoc.getPage(currentQuestion).then(page => {
                    const scale = 2;
                    const viewport = page.getViewport({ scale });
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise.then(() => {
                        // Draw saved paths for the current question
                        if (drawings[currentQuestion]) {
                            drawings[currentQuestion].forEach(({ path, mode }) => {
                                context.beginPath();
                                for (let i = 0; i < path.length - 1; i++) {
                                    context.moveTo(path[i].x, path[i].y);
                                    context.lineTo(path[i + 1].x, path[i + 1].y);
                                }

                                if (mode === "highlighter") {
                                    context.strokeStyle = "rgba(255, 255, 0, 0.3)"; // Yellow with 30% transparency
                                    context.lineWidth = 16; // Thicker line for highlighter
                                } else if (mode === "pen") {
                                    context.strokeStyle = "rgba(0, 0, 0, 1)"; // Black solid line
                                    context.lineWidth = 4; // Thicker line for pen
                                }

                                context.lineCap = "round";
                                context.stroke();
                                context.closePath();
                            });
                        }
                    });
                });
            }
        }

        function renderQuestionPdf() {
            const canvas = document.getElementById("pdf-canvas");
            renderDrawings(canvas);
        }

        function renderAnswerPdf() {
            if (!examSubmitted || !answerPdfDoc) return;
            renderPdf(answerPdfDoc, currentAnswerPage, "answer-pdf-canvas");
        }

        function setupExam() {
            if (totalQuestions === 0) {
                alert('Please upload a question PDF to set the total number of questions.');
                return;
            }

            calculateBlocks(); // Calculate blocks based on totalQuestions
            document.getElementById('start-exam-btn').disabled = false; // Enable the Start Exam button
        }

        function startExam() {
            if (!questionPdfDoc) {
                alert("Please upload a question PDF to start the exam.");
                return;
            }

            calculateBlocks(); // Calculate blocks before starting
            startBlock(); // Start the first block
            $("#start-exam-btn").hide(); // Hide the Start Exam button
        }

        function submitBlock() {
            if (currentBlock < totalBlocks) {
                saveCurrentAnswer();

                // Stop and remove the timer
                if (timer && timer.interval) {
                    clearInterval(timer.interval);
                    timer.interval = null;
                }
                $("#timer-container").empty(); // Remove the timer display

                breakTimeRemaining += timer.duration; // Add remaining block time to break time
                timer = null;
                startBreak(); // Start the break
            } else {
                submitExam(); // Submit the exam if it's the last block
            }
        }

        function submitExam() {
            saveCurrentAnswer();
            examSubmitted = true;
            $answerBox.prop("disabled", true);

            // Stop the timer
            if (timer && timer.interval) {
                clearInterval(timer.interval);
                timer.interval = null;
            }

            // Adjust container sizes
            $("#review-list-container").addClass("submitted");
            $("#answer-sheet-container").addClass("visible");

            if (answerPdfDoc) {
                renderAnswerPdf();
                $("#answer-sheet-container").show();
            }

            updateReviewList(); // Ensure review list is updated with answers
            $tabs.tabs("option", "active", 2); // Switch to the "Review Answers" tab
        }

        function startBreak() {
            isBreak = true;
            breakTimeRemaining = timer ? timer.duration : breakTimeRemaining; // Ensure breakTimeRemaining is set correctly
            timer = new ExamTimer(breakTimeRemaining, 'break-timer-display'); // Use a unique ID for the break timer

            // Remove any existing break screen to avoid duplicates
            $("#break-screen").remove();

            // Append the break screen
            $(".container").append(`
                <div id='break-screen'>
                    <h1 style='text-align: center; font-size: 2em;'>BREAK</h1>
                    <div id='break-timer-container' style='text-align: center; font-size: 1.5em; margin: 10px 0;'></div>
                    <button id='end-break-btn' style='display: block; margin: 20px auto; padding: 10px 20px; font-size: 1em;'>End Break</button>
                </div>
            `);

            // Render the timer in the break screen
            timer.renderTimer('break-timer-container');
            timer.start();

            // Hide the tabs
            $("#tabs").hide();

            // Add event listener for ending the break
            $("#end-break-btn").on("click", endBreak);
        }

        function endBreak() {
            breakTimeRemaining = timer.duration; // Save remaining break time
            currentBlock++;

            // Stop and remove any existing timer before starting the next block
            if (timer && timer.interval) {
                clearInterval(timer.interval);
                timer.interval = null;
            }
            $("#timer-container").empty(); // Clear the timer display

            $("#break-screen").remove(); // Remove the break screen
            $("#tabs").show(); // Restore the tabs
            startBlock(); // Start the next block
        }

        function initializeTimer() {
            const totalDuration = totalQuestions * 90; // 90 seconds per question
            timer = new ExamTimer(totalDuration, 'timer-display');
            timer.renderTimer('timer-container'); // Timer remains visible in the tab navigation area
            $("#start-exam-btn").prop("disabled", false); // Enable the "Start Exam" button
        }

        $(function() {
            $tabs.tabs({
                activate: function(event, ui) {
                    if (ui.newPanel.attr("id") === "review-tab") {
                        const blockStart = blockQuestions.slice(0, currentBlock - 1).reduce((a, b) => a + b, 0) + 1;
                        const blockEnd = blockStart + blockQuestions[currentBlock - 1] - 1;
                        updateReviewList(blockStart, blockEnd);
                        if (examSubmitted && answerPdfDoc) {
                            renderAnswerPdf();
                            $("#answer-sheet-container").show();
                        } else {
                            $("#answer-sheet-container").hide();
                        }
                    }
                }
            });

            $labTabs.tabs();

            $labSearch.on("input", debounce(function() {
                let searchTerm = $(this).val().trim();
                let tabsFound = {};

                if (!searchTerm) {
                    $labTabs.find("td, th").each(function() {
                        if ($(this).data("original")) {
                            $(this).html($(this).data("original"));
                        }
                    });
                    $("#lab-tabs ul li").removeClass("tab-highlight");
                    return;
                }

                $labTabs.find("td, th").each(function() {
                    let original = $(this).data("original");
                    if (!original) {
                        original = $(this).html();
                        $(this).data("original", original);
                    }
                    let regex = new RegExp(searchTerm, "gi"); // Allow partial matches
                    if (original.match(regex)) {
                        $(this).html(original.replace(regex, match => `<mark>${match}</mark>`)); // Fix highlighting issue
                        let parentTab = $(this).closest(".ui-tabs-panel").attr("id");
                        tabsFound[parentTab] = true;
                    } else {
                        $(this).html(original); // Remove highlights if no match
                    }
                });

                $("#lab-tabs ul li").each(function() {
                    let tabLink = $(this).find("a").attr("href").substring(1);
                    if (tabsFound[tabLink]) {
                        $(this).addClass("tab-highlight");
                    } else {
                        $(this).removeClass("tab-highlight");
                    }
                });
            }, 300));

            $("#prev-btn").on("click", function() {
                saveCurrentAnswer();
                const blockStart = blockQuestions.slice(0, currentBlock - 1).reduce((a, b) => a + b, 0) + 1;

                if (currentQuestion > blockStart) {
                    currentQuestion--;
                    updateQuestion();
                }
            });

            $("#next-btn").on("click", function() {
                saveCurrentAnswer();
                const blockStart = blockQuestions.slice(0, currentBlock - 1).reduce((a, b) => a + b, 0) + 1;
                const blockEnd = blockStart + blockQuestions[currentBlock - 1] - 1;

                if (currentQuestion < blockEnd) {
                    currentQuestion++;
                    updateQuestion();
                } else {
                    // Prompt the user to submit the block or exam
                    if (currentBlock < totalBlocks) {
                        if (confirm("You have reached the end of this block. Do you want to submit the block?")) {
                            submitBlock();
                        }
                    } else if (currentBlock === totalBlocks && currentQuestion === blockEnd) {
                        if (confirm("You have reached the end of the exam. Do you want to submit the exam?")) {
                            submitExam();
                        }
                    }
                }
            });

            $submitExamBtn.on("click", function() {
                saveCurrentAnswer();
                examSubmitted = true;
                $answerBox.prop("disabled", true);

                // Stop the timer and remove it from the UI
                if (timer && timer.interval) {
                    clearInterval(timer.interval);
                    timer.interval = null;
                }
                $("#timer-container").hide(); // Hide the timer container

                // Adjust container sizes
                $("#review-list-container").addClass("submitted");
                $("#answer-sheet-container").addClass("visible");

                if (answerPdfDoc) {
                    renderAnswerPdf();
                    $("#answer-sheet-container").show();
                }

                updateReviewList(); // Ensure review list is updated with answers
                $tabs.tabs("option", "active", 2); // Switch to the "Review Answers" tab

                // Restore unrestricted navigation for "Next" and "Previous" buttons
                $("#prev-btn").off("click").on("click", function() {
                    if (currentQuestion > 1) {
                        saveCurrentAnswer();
                        currentQuestion--;
                        updateQuestion();
                    }
                });

                $("#next-btn").off("click").on("click", function() {
                    if (currentQuestion < totalQuestions) {
                        saveCurrentAnswer();
                        currentQuestion++;
                        updateQuestion();
                    }
                });

                // Replace the "Submit Exam" button with a "Next Question" button
                $submitExamBtn.replaceWith("<button id='next-question-btn'>Next Question</button>");
                $("#next-question-btn").on("click", function() {
                    if (currentQuestion < totalQuestions) {
                        saveCurrentAnswer();
                        currentQuestion++;
                        updateQuestion();
                    }
                });
            });

            $("#pdf-upload").on("change", function() {
                const file = $(this).prop("files")[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const pdfData = event.target.result;
                        pdfjsLib.getDocument({
                            data: pdfData
                        }).promise.then(function(pdfDoc) {
                            questionPdfDoc = pdfDoc;
                            totalQuestions = pdfDoc.numPages; // Set totalQuestions
                            currentQuestion = 1;
                            setupExam(); // Call setupExam after setting totalQuestions
                        }).catch(function(error) {
                            console.error("Error loading question PDF:", error);
                        });
                    };
                    reader.readAsArrayBuffer(file);
                }
            });

            $("#pdf-answer-upload").on("change", function() {
                const file = $(this).prop("files")[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const pdfData = event.target.result;
                        pdfjsLib.getDocument({
                            data: pdfData
                        }).promise.then(function(pdfDoc) {
                            answerPdfDoc = pdfDoc;
                            currentAnswerPage = 1;
                            if (examSubmitted) {
                                renderAnswerPdf();
                                $("#answer-sheet-container").show();
                            }
                        }).catch(function(error) {
                            console.error("Error loading answer PDF:", error);
                        });
                    };
                    reader.readAsArrayBuffer(file);
                }
            });

            $("#prev-answer-page").on("click", function() {
                if (answerPdfDoc && currentAnswerPage > 1) {
                    currentAnswerPage--;
                    renderAnswerPdf();
                }
            });
            $("#next-answer-page").on("click", function() {
                if (answerPdfDoc && currentAnswerPage < answerPdfDoc.numPages) {
                    currentAnswerPage++;
                    renderAnswerPdf();
                }
            });

            $reviewList.on("click", "li", function() {
                saveCurrentAnswer();

                // Allow navigation to any question after the exam is submitted
                currentQuestion = parseInt($(this).data("q"));
                updateQuestion();
                $tabs.tabs("option", "active", 0); // Switch to the "Question" tab
            });

            $("#toggle-upload").on("click", function() {
                const $content = $(".upload-section-content");
                $content.slideToggle();
                const isVisible = $content.is(":visible");
                $(this).text(`Upload Options ${isVisible ? "â–²" : "â–¼"}`);
            });

            $(".upload-section-content").hide();

            $("#start-exam-btn").on("click", startExam);
            $("#start-exam-btn").prop("disabled", true); // Disable the "Start Exam" button initially

            const canvas = document.getElementById("pdf-canvas");
            enableDrawing(canvas);
        });

        let currentBlock = 1;
        let totalBlocks = 1;
        let blockQuestions = [];
        let breakTimeRemaining = 45 * 60; // Initial break time in seconds
        let isBreak = false;

        function calculateBlocks() {
            if (totalQuestions < 80) {
                totalBlocks = 1;
                blockQuestions = [totalQuestions];
            } else {
                totalBlocks = Math.ceil(totalQuestions / 40);
                blockQuestions = Array(totalBlocks).fill(40);
                blockQuestions[blockQuestions.length - 1] = totalQuestions % 40 || 40; // Adjust last block
            }
        }

        function startBlock() {
            isBreak = false;

            // Stop and remove any existing timer before starting a new block
            if (timer && timer.interval) {
                clearInterval(timer.interval);
                timer.interval = null;
            }
            $("#timer-container").empty(); // Clear the timer display

            const blockQuestionCount = blockQuestions[currentBlock - 1];
            const blockDuration = blockQuestionCount * 90; // 90 seconds per question
            timer = new ExamTimer(blockDuration, 'timer-display');
            timer.renderTimer('timer-container');
            timer.start();

            // Update UI for the block
            updateQuestion();
            $("#question-title").text(`Block ${currentBlock} - Question ${currentQuestion}`);
            $("#review-tab").hide(); // Hide review tab during blocks
            $("#answer-sheet-container").hide(); // Hide answer sheet
        }

        $(function() {
            $("#start-exam-btn").on("click", function() {
                if (!questionPdfDoc) {
                    alert("Please upload a question PDF to start the exam.");
                    return;
                }
                calculateBlocks();
                startBlock();
            });
        });

        function optimizeExam() {
            if (!questionPdfDoc) {
                alert("Please upload a question PDF to optimize the exam.");
                return;
            }

            calculateBlocks();

            let optimizationDetails = `<h3>Exam Structure</h3>`;
            optimizationDetails += `<p>Total Questions: ${totalQuestions}</p>`;
            optimizationDetails += `<p>Total Blocks: ${totalBlocks}</p>`;
            optimizationDetails += `<ul>`;
            blockQuestions.forEach((questionsInBlock, index) => {
                const blockTime = questionsInBlock * 90; // 90 seconds per question
                const minutes = Math.floor(blockTime / 60);
                const seconds = blockTime % 60;
                optimizationDetails += `<li>Block ${index + 1}: ${questionsInBlock} questions (${minutes}:${seconds.toString().padStart(2, "0")} minutes)</li>`;
            });
            optimizationDetails += `</ul>`;
            optimizationDetails += `<p>Initial Break Time: 45 minutes</p>`;

            $("#optimization-details").html(optimizationDetails).show();

            // Hide the "Optimize Exam" button after it is pressed
            $("#optimize-exam-btn").remove();
        }

        $(function() {
            // Add the "Optimize Exam" button next to "Start Exam"
            const $optimizeExamBtn = $("<button id='optimize-exam-btn' style='margin-left: 10px;'>Optimize Exam</button>");
            $("#start-exam-btn").after($optimizeExamBtn);

            // Add a container to display optimization details
            $(".container").append("<div id='optimization-details' style='display: none; margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9;'></div>");

            // Attach event listener to the "Optimize Exam" button
            $optimizeExamBtn.on("click", optimizeExam);
        });
    </script>
</body>

</html>